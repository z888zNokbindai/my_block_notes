<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<title>Block Note ‚ú¶</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet"/>
<style>
:root{
  --ink:#0a0a0f;--ink2:#111118;--panel:#1e1e2a;
  --border:#2e2e3e;--border2:#3a3a50;
  --canvas:#f4f3ef;--grid:#e8e6df;--grid2:#d5d2c8;
  --accent:#ff4d5e;--accent2:#ff8c42;
  --blue:#4ea8ff;--green:#3ecf8e;--purple:#a78bfa;--yellow:#fbbf24;
  --muted:#7a7a9a;--white:#fff;
  --sb:env(safe-area-inset-bottom,0px);
  --st:env(safe-area-inset-top,0px);
  --topbar:54px;--botbar:64px;
  --sh:0 4px 20px rgba(0,0,0,.18),0 1px 4px rgba(0,0,0,.1);
  --shlg:0 12px 40px rgba(0,0,0,.28),0 2px 8px rgba(0,0,0,.14);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;width:100%;overflow:hidden;
  font-family:'Syne',sans-serif;background:var(--ink);color:var(--white);
  user-select:none;-webkit-user-select:none;}

/* ‚îÄ TOP BAR ‚îÄ */
#topbar{
  position:fixed;top:0;left:0;right:0;z-index:200;
  height:calc(var(--topbar) + var(--st));
  padding-top:var(--st);
  background:var(--ink2);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:var(--st) 10px 0;gap:6px;
}
.logo{font-size:17px;font-weight:800;letter-spacing:-.5px;
  display:flex;align-items:center;gap:6px;flex:1;padding-left:4px;}
.logo-dot{width:7px;height:7px;border-radius:50%;
  background:var(--accent);box-shadow:0 0 8px var(--accent);}
.icon-btn{width:38px;height:38px;border-radius:10px;border:1px solid var(--border2);
  background:var(--panel);color:var(--white);font-size:16px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;}
.icon-btn:active{transform:scale(.9)}
#page-tab{display:flex;align-items:center;gap:5px;padding:0 10px;height:38px;
  border-radius:10px;border:1px solid var(--border2);background:var(--panel);
  color:var(--white);font-size:12px;font-weight:700;cursor:pointer;
  font-family:'Syne',sans-serif;max-width:120px;}
#page-tab:active{transform:scale(.95)}
#page-tab-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ‚îÄ CANVAS ‚îÄ */
#canvas-wrap{
  position:fixed;
  top:calc(var(--topbar) + var(--st));left:0;right:0;
  bottom:calc(var(--botbar) + var(--sb));
  overflow:auto;-webkit-overflow-scrolling:touch;
  background:var(--canvas);
  background-image:
    linear-gradient(var(--grid2) 1px,transparent 1px),
    linear-gradient(90deg,var(--grid2) 1px,transparent 1px),
    linear-gradient(var(--grid) 1px,transparent 1px),
    linear-gradient(90deg,var(--grid) 1px,transparent 1px);
  background-size:160px 160px,160px 160px,32px 32px,32px 32px;
}
#canvas-inner{position:relative;width:2800px;height:2400px;}
#svg-layer{position:absolute;inset:0;pointer-events:none;z-index:1;overflow:visible;}
#block-layer{position:absolute;inset:0;z-index:2;}

/* ‚îÄ BLOCKS ‚îÄ */
.block{
  position:absolute;width:200px;border-radius:14px;
  background:#fff;box-shadow:var(--sh);
  border:2.5px solid transparent;touch-action:none;
}
.block.selected{border-color:var(--accent);box-shadow:0 0 0 4px rgba(255,77,94,.2),var(--shlg);}
.block.connect-src{border-color:var(--yellow);box-shadow:0 0 0 4px rgba(251,191,36,.3),var(--shlg);}
.bh{padding:10px 12px;display:flex;align-items:center;gap:7px;}
.bi{font-size:14px;flex-shrink:0}
.bt{font-size:11px;font-weight:700;color:#fff;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.bb2{width:22px;height:22px;border-radius:6px;background:rgba(255,255,255,.22);
  display:flex;align-items:center;justify-content:center;
  font-size:10px;font-weight:800;color:#fff;font-family:'DM Mono',monospace;flex-shrink:0;}
.bdy{padding:10px 12px 14px;background:#fff;min-height:52px;}
.btxt{font-size:12px;line-height:1.6;color:#2a2a3a;font-family:'DM Mono',monospace;
  word-break:break-word;display:-webkit-box;-webkit-line-clamp:5;-webkit-box-orient:vertical;overflow:hidden;}
.bimg{width:100%;height:120px;border-radius:6px;background:#eeeae0;overflow:hidden;
  display:flex;align-items:center;justify-content:center;}
.bimg img{width:100%;height:100%;object-fit:cover;}
.bimgname{font-size:10px;color:#999;font-family:'DM Mono',monospace;margin-top:6px;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.type-text .bh{background:linear-gradient(135deg,#4ea8ff,#7b68ee);}
.type-image .bh{background:linear-gradient(135deg,#3ecf8e,#2db77b);}
.port{position:absolute;width:20px;height:20px;border-radius:50%;
  background:#fff;border:2.5px solid currentColor;z-index:5;touch-action:none;}
.port-n{top:-10px;left:calc(50% - 10px)}
.port-s{bottom:-10px;left:calc(50% - 10px)}
.port-w{left:-10px;top:calc(50% - 10px)}
.port-e{right:-10px;top:calc(50% - 10px)}
.type-text .port{color:var(--blue)}.type-image .port{color:var(--green)}

/* ‚îÄ ACTION BAR (floats above canvas when block selected) ‚îÄ */
#action-bar{
  position:fixed;top:calc(var(--topbar) + var(--st) + 8px);left:50%;
  transform:translateX(-50%);
  background:var(--ink2);border:1px solid var(--border2);border-radius:14px;
  padding:6px 8px;display:none;align-items:center;gap:5px;
  z-index:190;box-shadow:var(--shlg);white-space:nowrap;
  animation:pop .2s cubic-bezier(.34,1.56,.64,1);
}
#action-bar.show{display:flex}
@keyframes pop{from{transform:translateX(-50%) scale(.85);opacity:0}to{transform:translateX(-50%) scale(1);opacity:1}}
.ab{padding:8px 10px;border-radius:9px;border:none;font-family:'Syne',sans-serif;
  font-size:11px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:4px;}
.ab:active{transform:scale(.9)}

/* ‚îÄ CONNECT BANNER ‚îÄ */
#conn-banner{
  position:fixed;top:calc(var(--topbar) + var(--st) + 8px);left:50%;
  transform:translateX(-50%);
  background:rgba(255,77,94,.95);border-radius:14px;padding:8px 16px;
  font-size:12px;font-weight:700;color:#fff;z-index:191;
  display:none;align-items:center;gap:8px;box-shadow:var(--shlg);white-space:nowrap;
}
#conn-banner.show{display:flex}
#conn-banner button{background:rgba(255,255,255,.25);border:none;color:#fff;
  border-radius:7px;padding:5px 10px;font-size:11px;font-weight:700;
  cursor:pointer;font-family:'Syne',sans-serif;}

/* ‚îÄ BOTTOM NAV ‚îÄ */
#botnav{
  position:fixed;bottom:0;left:0;right:0;z-index:200;
  height:calc(var(--botbar) + var(--sb));
  padding-bottom:var(--sb);
  background:var(--ink2);border-top:1px solid var(--border);
  display:flex;align-items:center;padding-left:4px;padding-right:4px;gap:2px;
}
.nb{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;padding:6px 2px;border-radius:12px;border:none;
  background:transparent;cursor:pointer;transition:.15s;min-height:52px;}
.nb:active{transform:scale(.88)}
.nb .ni{font-size:20px;line-height:1}
.nb .nl{font-size:9px;font-weight:700;font-family:'Syne',sans-serif;letter-spacing:.2px;color:var(--muted)}
.nb.c-blue .nl,.nb.c-blue .ni{color:var(--blue)}
.nb.c-orange .nl,.nb.c-orange .ni{color:var(--accent2)}
.nb.c-red .nl,.nb.c-red .ni{color:var(--accent)}
.nb.c-purple .nl,.nb.c-purple .ni{color:var(--purple)}
.nb.c-green .nl,.nb.c-green .ni{color:var(--green)}
.nb.conn-on{background:rgba(255,77,94,.12);border-radius:12px;animation:pnav .9s ease-in-out infinite;}
.nb.conn-on .ni,.nb.conn-on .nl{color:var(--accent)!important}
@keyframes pnav{0%,100%{box-shadow:none}50%{box-shadow:0 0 0 6px rgba(255,77,94,.0)}}

/* ‚îÄ FAB ‚îÄ */
#fab{
  position:fixed;right:16px;
  bottom:calc(var(--botbar) + var(--sb) + 14px);
  width:54px;height:54px;border-radius:18px;border:none;
  background:linear-gradient(135deg,var(--blue),var(--purple));
  color:#fff;font-size:26px;display:flex;align-items:center;justify-content:center;
  box-shadow:0 6px 24px rgba(78,168,255,.4);cursor:pointer;z-index:210;
  transition:transform .2s cubic-bezier(.34,1.56,.64,1),background .2s;
}
#fab:active{transform:scale(.86)}
#fab.open{transform:rotate(45deg);
  background:linear-gradient(135deg,var(--accent),#c0392b);
  box-shadow:0 6px 24px rgba(255,77,94,.4);}
#fab-menu{
  position:fixed;right:14px;
  bottom:calc(var(--botbar) + var(--sb) + 82px);
  display:flex;flex-direction:column;gap:10px;z-index:209;
  pointer-events:none;opacity:0;transform:translateY(16px) scale(.9);
  transform-origin:bottom right;transition:all .22s cubic-bezier(.34,1.56,.64,1);
}
#fab-menu.open{opacity:1;transform:none;pointer-events:auto}
.fi{display:flex;align-items:center;gap:10px;justify-content:flex-end;}
.fl{background:var(--ink2);color:#fff;font-size:12px;font-weight:700;
  padding:7px 12px;border-radius:10px;border:1px solid var(--border2);
  white-space:nowrap;box-shadow:var(--sh);}
.fb{width:46px;height:46px;border-radius:14px;border:none;color:#fff;font-size:20px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;
  box-shadow:var(--sh);flex-shrink:0;}
.fb:active{transform:scale(.86)}

/* ‚îÄ DRAWER ‚îÄ */
#drawer-overlay{position:fixed;inset:0;background:rgba(0,0,0,0);z-index:300;
  pointer-events:none;transition:background .25s;}
#drawer-overlay.open{background:rgba(0,0,0,.55);pointer-events:auto;}
#drawer{
  position:fixed;bottom:0;left:0;right:0;
  background:var(--ink2);border-radius:20px 20px 0 0;
  border-top:1px solid var(--border2);z-index:301;
  transform:translateY(100%);transition:transform .3s cubic-bezier(.23,1,.32,1);
  max-height:80vh;display:flex;flex-direction:column;padding-bottom:var(--sb);
}
#drawer.open{transform:translateY(0)}
.dhandle{width:36px;height:4px;border-radius:99px;background:var(--border2);margin:12px auto 0;flex-shrink:0;}
.dtitle{padding:14px 18px 8px;font-size:14px;font-weight:800;
  border-bottom:1px solid var(--border);flex-shrink:0;
  display:flex;align-items:center;justify-content:space-between;}
#dplist{flex:1;overflow-y:auto;padding:10px 12px;}
.dpi{display:flex;align-items:center;gap:10px;padding:13px 12px;border-radius:12px;
  cursor:pointer;margin-bottom:4px;}
.dpi:active{background:var(--panel)}
.dpi.active{background:linear-gradient(120deg,rgba(78,168,255,.15),rgba(167,139,250,.08));
  border:1px solid rgba(78,168,255,.25);}
.dpdot{width:8px;height:8px;border-radius:50%;background:var(--muted);flex-shrink:0;}
.dpi.active .dpdot{background:var(--blue);box-shadow:0 0 8px var(--blue);}
.dpname{font-size:14px;font-weight:600;color:#ccc;flex:1;}
.dpi.active .dpname{color:var(--blue);font-weight:700;}
.dpcnt{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;}
.dacts{padding:10px 12px;border-top:1px solid var(--border);
  display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;flex-shrink:0;}
.da{padding:12px 8px;border-radius:12px;border:none;
  font-family:'Syne',sans-serif;font-size:11px;font-weight:700;cursor:pointer;
  display:flex;flex-direction:column;align-items:center;gap:4px;}
.da:active{transform:scale(.92)}
.da span{font-size:18px;}

/* ‚îÄ MODAL ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:400;
  display:flex;align-items:flex-end;backdrop-filter:blur(4px);animation:fin .15s;}
@keyframes fin{from{opacity:0}to{opacity:1}}
.modal{background:var(--panel);border:1px solid var(--border2);
  border-radius:20px 20px 0 0;width:100%;box-shadow:var(--shlg);
  animation:sup .25s cubic-bezier(.23,1,.32,1);
  padding-bottom:var(--sb);max-height:88vh;display:flex;flex-direction:column;}
@keyframes sup{from{transform:translateY(30px);opacity:0}to{transform:none;opacity:1}}
@media(min-width:600px){
  .overlay{align-items:center;justify-content:center;}
  .modal{border-radius:18px;max-width:560px;width:100%;}
}
.mhandle{width:36px;height:4px;border-radius:99px;background:var(--border2);margin:12px auto 0;flex-shrink:0;}
.mhead{padding:14px 18px 10px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:10px;flex-shrink:0;}
.mtitle{font-size:16px;font-weight:800;}
.mbody{padding:16px 18px;overflow-y:auto;flex:1;}
.mfoot{padding:12px 18px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;}
.mfoot button{flex:1}
textarea.ea{
  width:100%;min-height:160px;background:var(--ink2);color:#fff;
  border:1.5px solid var(--border2);border-radius:12px;padding:14px;
  font-family:'DM Mono',monospace;font-size:14px;line-height:1.6;
  resize:none;outline:none;transition:border-color .15s;
  user-select:text;-webkit-user-select:text;pointer-events:auto;cursor:text;}
textarea.ea:focus{border-color:var(--blue);}

/* ‚îÄ SEQ ITEMS ‚îÄ */
.si{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;
  background:var(--ink2);border:1px solid var(--border);margin-bottom:6px;}
.sn{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;
  justify-content:center;font-size:12px;font-weight:800;font-family:'DM Mono',monospace;flex-shrink:0;}
.sc{font-size:13px;color:#ccc;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;}
.ci{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:8px;
  background:rgba(255,77,94,.08);border:1px solid rgba(255,77,94,.2);
  font-size:11px;font-family:'DM Mono',monospace;color:#ddd;margin-bottom:5px;}

/* ‚îÄ SHARED BTN ‚îÄ */
.btn{padding:13px 16px;border-radius:12px;border:none;font-family:'Syne',sans-serif;
  font-size:13px;font-weight:700;cursor:pointer;transition:.15s;
  display:flex;align-items:center;justify-content:center;gap:6px;}
.btn:active{transform:scale(.94)}
.btn-blue{background:var(--blue);color:#0a0a18}
.btn-dark{background:var(--ink2);color:#ccc;border:1px solid var(--border2)}

/* ‚îÄ CONN SVG ‚îÄ */
.cp{fill:none;stroke:var(--accent);stroke-width:2.5;marker-end:url(#arr)}

/* ‚îÄ TOAST ‚îÄ */
#toast{
  position:fixed;top:calc(var(--topbar) + var(--st) + 8px);left:50%;
  transform:translateX(-50%) translateY(-6px);
  padding:9px 18px;border-radius:12px;background:var(--ink2);color:#fff;
  border:1px solid var(--border2);font-size:12px;font-weight:700;
  box-shadow:var(--shlg);opacity:0;transition:all .25s cubic-bezier(.23,1,.32,1);
  z-index:500;pointer-events:none;white-space:nowrap;max-width:88vw;
  display:flex;align-items:center;gap:8px;}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<!-- TOP BAR -->
<div id="topbar">
  <div class="logo"><div class="logo-dot"></div>Block Note</div>
  <button class="icon-btn" onclick="saveProject()">üíæ</button>
  <button class="icon-btn" onclick="loadProject()">üìÇ</button>
  <button id="page-tab" onclick="openDrawer()">
    <span id="page-tab-name">Page 1</span>
    <span style="opacity:.45;font-size:10px;flex-shrink:0">‚ñæ</span>
  </button>
</div>

<!-- CANVAS -->
<div id="canvas-wrap" ondragover="canvasDragOver(event)" ondrop="canvasDrop(event)">
  <div id="canvas-inner">
    <svg id="svg-layer">
      <defs>
        <marker id="arr" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0,10 3.5,0 7" fill="var(--accent)"/>
        </marker>
        <marker id="arr-t" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0,10 3.5,0 7" fill="var(--yellow)"/>
        </marker>
      </defs>
      <g id="cg"></g>
      <g id="tcg"></g>
    </svg>
    <div id="block-layer"></div>
  </div>
</div>

<!-- ACTION BAR -->
<div id="action-bar">
  <button class="ab" style="background:var(--blue);color:#0a0a18" onclick="ctxEdit()">‚úè ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
  <button class="ab" style="background:var(--panel);color:#ccc;border:1px solid var(--border2)" onclick="orderUp()">‚Üë</button>
  <button class="ab" style="background:var(--panel);color:#ccc;border:1px solid var(--border2)" onclick="orderDown()">‚Üì</button>
  <button class="ab" style="background:rgba(255,77,94,.15);color:var(--accent);border:1px solid rgba(255,77,94,.28)" onclick="deleteSelected()">‚úï ‡∏•‡∏ö</button>
</div>

<!-- CONNECT BANNER -->
<div id="conn-banner">
  <span id="conn-hint">üëÜ ‡πÅ‡∏ï‡∏∞ Block ‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</span>
  <button onclick="cancelConnect()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>

<!-- BOTTOM NAV -->
<div id="botnav">
  <button class="nb c-blue" onclick="toggleFab()">
    <span class="ni">Ôºã</span><span class="nl">‡πÄ‡∏û‡∏¥‡πà‡∏°</span>
  </button>
  <button class="nb c-orange" id="conn-btn" onclick="toggleConnect()">
    <span class="ni">‚ü∂</span><span class="nl">Connect</span>
  </button>
  <button class="nb c-red" onclick="disconnectSelected()">
    <span class="ni">‚úÇ</span><span class="nl">‡∏ï‡∏±‡∏î‡πÄ‡∏™‡πâ‡∏ô</span>
  </button>
  <button class="nb c-purple" onclick="showSequence()">
    <span class="ni">‚â°</span><span class="nl">‡∏•‡∏≥‡∏î‡∏±‡∏ö</span>
  </button>
  <button class="nb c-green" onclick="openDrawer()">
    <span class="ni">üìÑ</span><span class="nl">Pages</span>
  </button>
</div>

<!-- FAB -->
<button id="fab" onclick="toggleFab()">Ôºã</button>
<div id="fab-menu">
  <div class="fi">
    <span class="fl">Text Block</span>
    <button class="fb" style="background:linear-gradient(135deg,var(--blue),#7b68ee)" onclick="addTextBlock()">‚ú¶</button>
  </div>
  <div class="fi">
    <span class="fl">Image Block</span>
    <button class="fb" style="background:linear-gradient(135deg,var(--green),#2db77b)" onclick="addImageBlock()">‚¨°</button>
  </div>
</div>

<!-- DRAWER (pages) -->
<div id="drawer-overlay" onclick="closeDrawer()"></div>
<div id="drawer">
  <div class="dhandle"></div>
  <div class="dtitle">
    <span>Pages</span>
    <span id="dpcount" style="font-size:11px;color:var(--muted);font-weight:400"></span>
  </div>
  <div id="dplist"></div>
  <div class="dacts">
    <button class="da" style="background:rgba(62,207,142,.12);color:var(--green)" onclick="addPage()">
      <span>Ôºã</span>New Page
    </button>
    <button class="da" style="background:rgba(78,168,255,.12);color:var(--blue)" onclick="renamePage()">
      <span>‚úè</span>Rename
    </button>
    <button class="da" style="background:rgba(255,77,94,.1);color:var(--accent)" onclick="deletePage()">
      <span>‚úï</span>Delete
    </button>
  </div>
</div>

<!-- EDIT MODAL -->
<div id="modal-edit" class="overlay" style="display:none" onclick="if(event.target===this)closeModal('modal-edit')">
  <div class="modal">
    <div class="mhandle"></div>
    <div class="mhead"><span style="font-size:20px">‚úè</span><div class="mtitle">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Block</div></div>
    <div class="mbody">
      <textarea class="ea" id="edit-ta" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‚Ä¶" rows="7"></textarea>
    </div>
    <div class="mfoot">
      <button class="btn btn-dark" onclick="closeModal('modal-edit')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-blue" onclick="saveEdit()">‚úì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- SEQ MODAL -->
<div id="modal-seq" class="overlay" style="display:none" onclick="if(event.target===this)closeModal('modal-seq')">
  <div class="modal">
    <div class="mhandle"></div>
    <div class="mhead"><span style="font-size:20px">‚â°</span><div class="mtitle" id="seq-title">‡∏•‡∏≥‡∏î‡∏±‡∏ö Block</div></div>
    <div class="mbody" id="seq-body" style="overflow-y:auto"></div>
    <div class="mfoot"><button class="btn btn-blue" onclick="closeModal('modal-seq')">‡∏õ‡∏¥‡∏î</button></div>
  </div>
</div>

<div id="toast"></div>
<input type="file" id="img-in" accept="image/*" style="display:none" onchange="imgChosen(event)"/>
<input type="file" id="load-in" accept=".blocknote,.json" style="display:none" onchange="loadFile(event)"/>

<script>
/* STATE */
let pages=[{id:1,name:'Page 1',blocks:[],connections:[]}];
let curPage=0,blockIdCtr=0,pageIdCtr=1;
let selectedId=null,connectMode=false,connectSrcId=null,connectSrcPort='s';
let dragging=null,editingId=null,pendingImgId=null,fabOpen=false;
let lpTimer=null;

const pg=()=>pages[curPage];
const gb=id=>pg().blocks.find(b=>b.id===id)||null;

/* PAGES */
function renderSidebar(){
  document.getElementById('page-tab-name').textContent=pg().name;
  document.getElementById('dpcount').textContent=`${pages.length} pages`;
  const list=document.getElementById('dplist');list.innerHTML='';
  pages.forEach((p,i)=>{
    const d=document.createElement('div');
    d.className='dpi'+(i===curPage?' active':'');
    d.innerHTML=`<div class="dpdot"></div><div class="dpname">${esc(p.name)}</div><div class="dpcnt">${p.blocks.length} blocks</div>`;
    d.onclick=()=>{switchPage(i);closeDrawer();};
    list.appendChild(d);
  });
}
function switchPage(i){curPage=i;selectedId=null;cancelConnect();hideAbar();renderSidebar();renderAll();}
function openDrawer(){document.getElementById('drawer').classList.add('open');document.getElementById('drawer-overlay').classList.add('open');renderSidebar();}
function closeDrawer(){document.getElementById('drawer').classList.remove('open');document.getElementById('drawer-overlay').classList.remove('open');}
function addPage(){const n=prompt('‡∏ä‡∏∑‡πà‡∏≠ Page:',`Page ${pages.length+1}`);if(!n)return;pages.push({id:++pageIdCtr,name:n,blocks:[],connections:[]});curPage=pages.length-1;closeDrawer();renderSidebar();renderAll();toast('‡πÄ‡∏û‡∏¥‡πà‡∏°: '+n,'üìÑ');}
function renamePage(){const n=prompt('‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà:',pg().name);if(n){pg().name=n;renderSidebar();}}
function deletePage(){if(pages.length===1){toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö Page ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÑ‡∏î‡πâ','‚ö†');return;}if(!confirm(`‡∏•‡∏ö "${pg().name}"?`))return;pages.splice(curPage,1);curPage=Math.max(0,curPage-1);selectedId=null;closeDrawer();renderSidebar();renderAll();}

/* BLOCKS */
function nextPos(){
  const n=pg().blocks.length;
  const w=document.getElementById('canvas-wrap');
  return{x:Math.max(20,w.scrollLeft+40+(n%4)*30),y:Math.max(20,w.scrollTop+80+(n%4)*40)};
}
function addTextBlock(){
  closeFab();const{x,y}=nextPos();
  const b={id:++blockIdCtr,type:'text',content:'‚ú¶ Block ‡πÉ‡∏´‡∏°‡πà\n‡πÅ‡∏ï‡∏∞‡∏™‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',x,y,w:200,order:pg().blocks.length+1};
  pg().blocks.push(b);selectedId=b.id;renderAll();showAbar();
  setTimeout(()=>openEditModal(b.id),80);
}
function addImageBlock(){closeFab();pendingImgId=null;document.getElementById('img-in').click();}
function imgChosen(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();
  r.onload=ev=>{
    if(pendingImgId){const b=gb(pendingImgId);if(b){b.imgSrc=ev.target.result;b.content=f.name;renderAll();}pendingImgId=null;}
    else{const{x,y}=nextPos();const b={id:++blockIdCtr,type:'image',content:f.name,imgSrc:ev.target.result,x,y,w:200,order:pg().blocks.length+1};pg().blocks.push(b);selectedId=b.id;renderAll();showAbar();}
  };r.readAsDataURL(f);e.target.value='';
}
function deleteSelected(){
  if(!selectedId)return;
  const p=pg();p.connections=p.connections.filter(c=>c.src!==selectedId&&c.dst!==selectedId);
  const i=p.blocks.findIndex(b=>b.id===selectedId);if(i!==-1){p.blocks.splice(i,1);reorder();}
  selectedId=null;hideAbar();renderAll();toast('‡∏•‡∏ö Block ‡πÅ‡∏•‡πâ‡∏ß','üóë');
}
function reorder(){pg().blocks.forEach((b,i)=>b.order=i+1);}
function orderUp(){if(!selectedId)return;const p=pg(),i=p.blocks.findIndex(b=>b.id===selectedId);if(i>0){[p.blocks[i],p.blocks[i-1]]=[p.blocks[i-1],p.blocks[i]];reorder();renderAll();}}
function orderDown(){if(!selectedId)return;const p=pg(),i=p.blocks.findIndex(b=>b.id===selectedId);if(i<p.blocks.length-1){[p.blocks[i],p.blocks[i+1]]=[p.blocks[i+1],p.blocks[i]];reorder();renderAll();}}

/* CONNECT */
function toggleConnect(){
  connectMode=!connectMode;
  const btn=document.getElementById('conn-btn'),banner=document.getElementById('conn-banner');
  if(connectMode){btn.classList.add('conn-on');banner.classList.add('show');document.getElementById('conn-hint').textContent='üëÜ ‡πÅ‡∏ï‡∏∞ Block ‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á';}
  else cancelConnect();
}
function cancelConnect(){
  connectMode=false;connectSrcId=null;connectSrcPort='s';
  document.getElementById('conn-btn').classList.remove('conn-on');
  document.getElementById('conn-banner').classList.remove('show');
  document.getElementById('tcg').innerHTML='';
  updateClasses();
}
function disconnectSelected(){
  if(!selectedId){toast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Block ‡∏Å‡πà‡∏≠‡∏ô','‚ö†');return;}
  const bf=pg().connections.length;
  pg().connections=pg().connections.filter(c=>c.src!==selectedId&&c.dst!==selectedId);
  renderConnections();toast(`‡∏•‡∏ö ${bf-pg().connections.length} ‡πÄ‡∏™‡πâ‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°`,'‚úÇ');
}
function handleConnect(blockId,port){
  if(!connectSrcId){
    connectSrcId=blockId;connectSrcPort=port;selectedId=blockId;updateClasses();
    document.getElementById('conn-hint').textContent='üëÜ ‡πÅ‡∏ï‡∏∞ Block ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á';
    toast(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á #${gb(blockId)?.order}`,'‚ú¶');
  } else if(blockId!==connectSrcId){
    const ex=pg().connections.some(c=>c.src===connectSrcId&&c.dst===blockId);
    if(!ex)pg().connections.push({src:connectSrcId,src_port:connectSrcPort,dst:blockId,dst_port:port});
    const s=gb(connectSrcId),d=gb(blockId);
    toast(ex?'‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß':`‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° #${s?.order} ‚Üí #${d?.order}`,'‚ü∂');
    connectSrcId=null;connectSrcPort='s';document.getElementById('tcg').innerHTML='';
    document.getElementById('conn-hint').textContent='üëÜ ‡πÅ‡∏ï‡∏∞ Block ‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á';
    renderConnections();updateClasses();
  }
}

/* FAB */
function toggleFab(){fabOpen?closeFab():openFab();}
function openFab(){fabOpen=true;document.getElementById('fab').classList.add('open');document.getElementById('fab-menu').classList.add('open');}
function closeFab(){fabOpen=false;document.getElementById('fab').classList.remove('open');document.getElementById('fab-menu').classList.remove('open');}
document.addEventListener('click',e=>{if(fabOpen&&!e.target.closest('#fab')&&!e.target.closest('#fab-menu'))closeFab();});

/* ACTION BAR */
function showAbar(){document.getElementById('action-bar').classList.add('show');}
function hideAbar(){document.getElementById('action-bar').classList.remove('show');}

/* RENDER */
function renderAll(){renderBlocks();renderConnections();renderSidebar();}
function renderBlocks(){
  const layer=document.getElementById('block-layer');layer.innerHTML='';
  pg().blocks.forEach(b=>layer.appendChild(mkBlock(b)));
}
function mkBlock(b){
  const div=document.createElement('div');
  div.className=`block type-${b.type}${b.id===selectedId?' selected':''}${b.id===connectSrcId?' connect-src':''}`;
  div.id=`block-${b.id}`;
  div.style.cssText=`left:${b.x}px;top:${b.y}px;width:${b.w}px`;
  const icon=b.type==='text'?'‚ú¶':'‚¨°';
  const ti=b.type==='text'?b.content.split('\n')[0].slice(0,26):b.content.slice(0,26);
  let body='';
  if(b.type==='text'){body=`<div class="btxt">${esc(b.content)}</div>`;}
  else{const im=b.imgSrc?`<img src="${b.imgSrc}" alt=""/>`:`<div style="color:#aaa;font-size:13px">‚¨° ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</div>`;
    body=`<div class="bimg">${im}</div><div class="bimgname">${esc(b.content)}</div>`;}
  div.innerHTML=`
    <div class="bh"><span class="bi">${icon}</span><span class="bt">${esc(ti)}</span><span class="bb2">${b.order}</span></div>
    <div class="bdy">${body}</div>
    <div class="port port-n" data-p="n"></div>
    <div class="port port-s" data-p="s"></div>
    <div class="port port-w" data-p="w"></div>
    <div class="port port-e" data-p="e"></div>`;

  /* touch events */
  div.addEventListener('touchstart', e=>bTouchStart(e,b.id),{passive:false});
  div.addEventListener('touchmove',  e=>bTouchMove(e,b.id), {passive:false});
  div.addEventListener('touchend',   e=>bTouchEnd(e,b.id),  {passive:false});
  div.addEventListener('touchcancel',e=>bTouchEnd(e,b.id),  {passive:false});
  /* mouse events */
  div.addEventListener('mousedown', e=>bMouseDown(e,b.id));
  div.addEventListener('dblclick',  e=>bDblClick(e,b.id));

  /* port events */
  div.querySelectorAll('.port').forEach(pe=>{
    const side=pe.dataset.p;
    pe.addEventListener('touchstart',e=>{e.stopPropagation();e.preventDefault();portAct(b.id,side);},{passive:false});
    pe.addEventListener('mousedown', e=>{e.stopPropagation();portAct(b.id,side);});
  });
  return div;
}
function updateClasses(){
  pg().blocks.forEach(b=>{
    const el=document.getElementById(`block-${b.id}`);if(!el)return;
    el.className=`block type-${b.type}${b.id===selectedId?' selected':''}${b.id===connectSrcId?' connect-src':''}`;
  });
}

/* SVG CONNECTIONS */
function renderConnections(){
  const g=document.getElementById('cg');g.innerHTML='';
  const map=Object.fromEntries(pg().blocks.map(b=>[b.id,b]));
  pg().connections.forEach(c=>{
    const s=map[c.src],d=map[c.dst];if(!s||!d)return;
    const sp=c.src_port||'s',dp=c.dst_port||'n';
    const[x1,y1]=portPos(s,sp),[x2,y2]=portPos(d,dp);
    const path=svgEl('path');path.setAttribute('d',bezier(x1,y1,sp,x2,y2,dp));path.setAttribute('class','cp');
    const mx=(x1+x2)/2,my=(y1+y2)/2;
    const ci=svgEl('circle');ci.setAttribute('cx',mx);ci.setAttribute('cy',my);ci.setAttribute('r',12);ci.setAttribute('fill','var(--accent)');
    const tx=svgEl('text');tx.setAttribute('x',mx);tx.setAttribute('y',my+4);tx.setAttribute('text-anchor','middle');
    tx.setAttribute('font-size','9');tx.setAttribute('font-family','DM Mono,monospace');tx.setAttribute('font-weight','700');tx.setAttribute('fill','white');
    tx.textContent=`${s.order}‚Üí${d.order}`;
    g.appendChild(path);g.appendChild(ci);g.appendChild(tx);
  });
}
function svgEl(t){return document.createElementNS('http://www.w3.org/2000/svg',t);}
function portPos(b,side){
  const el=document.getElementById(`block-${b.id}`);const h=el?el.offsetHeight:120;
  if(side==='n')return[b.x+b.w/2,b.y];if(side==='s')return[b.x+b.w/2,b.y+h];
  if(side==='w')return[b.x,b.y+h/2];if(side==='e')return[b.x+b.w,b.y+h/2];
  return[b.x+b.w/2,b.y+h/2];
}
function bezier(x1,y1,sp,x2,y2,dp){
  const d=Math.max(Math.sqrt((x2-x1)**2+(y2-y1)**2)*.45,60);
  const dir={n:[0,-1],s:[0,1],e:[1,0],w:[-1,0]};
  const[d1x,d1y]=dir[sp]||[0,1],[d2x,d2y]=dir[dp]||[0,-1];
  return`M${x1} ${y1} C${x1+d1x*d} ${y1+d1y*d},${x2+d2x*d} ${y2+d2y*d},${x2} ${y2}`;
}
function autoPort(b,cx,cy){
  const el=document.getElementById(`block-${b.id}`);const h=el?el.offsetHeight:120;
  const dx=cx-(b.x+b.w/2),dy=cy-(b.y+h/2);
  return Math.abs(dx)>Math.abs(dy)?(dx>0?'e':'w'):(dy>0?'s':'n');
}
function drawTempLine(x1,y1,sp,x2,y2){
  const g=document.getElementById('tcg');g.innerHTML='';
  const d=Math.max(60,Math.sqrt((x2-x1)**2+(y2-y1)**2)*.4);
  const dir={n:[0,-1],s:[0,1],e:[1,0],w:[-1,0]};const[d1x,d1y]=dir[sp]||[0,1];
  const p=svgEl('path');p.setAttribute('d',`M${x1} ${y1} C${x1+d1x*d} ${y1+d1y*d},${x2} ${y2-d},${x2} ${y2}`);
  p.setAttribute('stroke','var(--yellow)');p.setAttribute('stroke-width','2');p.setAttribute('fill','none');
  p.setAttribute('stroke-dasharray','8,4');p.setAttribute('marker-end','url(#arr-t)');g.appendChild(p);
}

/* PORT ACTION */
function portAct(id,side){
  if(!connectMode){
    connectMode=true;
    document.getElementById('conn-btn').classList.add('conn-on');
    document.getElementById('conn-banner').classList.add('show');
  }
  handleConnect(id,side);
}

/* TOUCH LOGIC */
let tapTime=0,tapId=null;
const LP=500,DRAG_TH=8;
function bTouchStart(e,id){
  if(e.touches.length>1)return;e.stopPropagation();
  const t=e.touches[0];const pos=cvPos(t.clientX,t.clientY);
  clearTimeout(lpTimer);
  if(connectMode){handleConnect(id,autoPort(gb(id),pos.x,pos.y));return;}
  lpTimer=setTimeout(()=>{
    dragging=null;selectedId=id;updateClasses();showAbar();vibrate(25);
  },LP);
  const b=gb(id);
  dragging={id,sx:t.clientX,sy:t.clientY,bx:b.x,by:b.y,moved:false};
}
function bTouchMove(e,id){
  if(!dragging||dragging.id!==id)return;
  if(e.touches.length>1){dragging=null;return;}
  e.preventDefault();e.stopPropagation();
  const t=e.touches[0];const dx=t.clientX-dragging.sx,dy=t.clientY-dragging.sy;
  if(!dragging.moved&&Math.sqrt(dx*dx+dy*dy)>DRAG_TH){dragging.moved=true;clearTimeout(lpTimer);}
  if(!dragging.moved)return;
  const b=gb(id);if(!b)return;
  b.x=Math.max(0,dragging.bx+dx);b.y=Math.max(0,dragging.by+dy);
  const el=document.getElementById(`block-${id}`);if(el){el.style.left=b.x+'px';el.style.top=b.y+'px';}
  renderConnections();
}
function bTouchEnd(e,id){
  clearTimeout(lpTimer);const was=dragging?.moved;dragging=null;
  if(connectMode||was)return;
  const now=Date.now();
  if(tapId===id&&now-tapTime<360){tapTime=0;tapId=null;bDblClick(null,id);return;}
  tapTime=now;tapId=id;selectedId=id;updateClasses();showAbar();
}

/* MOUSE LOGIC */
function bMouseDown(e,id){
  if(e.button!==0)return;e.stopPropagation();
  if(connectMode){const pos=cvPos(e.clientX,e.clientY);handleConnect(id,autoPort(gb(id),pos.x,pos.y));return;}
  const prev=selectedId;selectedId=id;if(prev!==id){updateClasses();showAbar();}
  const b=gb(id);const pos=cvPos(e.clientX,e.clientY);
  dragging={id,sx:e.clientX,sy:e.clientY,bx:b.x,by:b.y,moved:false};
  document.getElementById('canvas-wrap').style.cursor='grabbing';
}
function bDblClick(e,id){
  if(e){e.stopPropagation();e.preventDefault();}dragging=null;
  const b=gb(id);if(!b)return;
  if(b.type==='text')openEditModal(id);else{pendingImgId=id;document.getElementById('img-in').click();}
}

/* CANVAS MOUSE */
const cw=document.getElementById('canvas-wrap');
cw.addEventListener('mousemove',e=>{
  if(!dragging)return;const dx=e.clientX-dragging.sx,dy=e.clientY-dragging.sy;
  if(!dragging.moved&&Math.sqrt(dx*dx+dy*dy)>4){dragging.moved=true;}
  if(!dragging.moved)return;
  const b=gb(dragging.id);if(!b)return;
  b.x=Math.max(0,dragging.bx+dx);b.y=Math.max(0,dragging.by+dy);
  const el=document.getElementById(`block-${dragging.id}`);if(el){el.style.left=b.x+'px';el.style.top=b.y+'px';}
  renderConnections();
  if(connectMode&&connectSrcId){const s=gb(connectSrcId);if(s){const[x1,y1]=portPos(s,connectSrcPort);const p=cvPos(e.clientX,e.clientY);drawTempLine(x1,y1,connectSrcPort,p.x,p.y);}}
});
cw.addEventListener('mouseup',()=>{dragging=null;cw.style.cursor=connectMode?'crosshair':'default';});
cw.addEventListener('mousedown',e=>{
  if([cw,document.getElementById('canvas-inner'),document.getElementById('block-layer')].includes(e.target)){
    if(connectMode)return;selectedId=null;hideAbar();updateClasses();
  }
});
cw.addEventListener('touchmove',e=>{
  if(connectMode&&connectSrcId&&e.touches.length===1){
    const t=e.touches[0];const s=gb(connectSrcId);
    if(s){const[x1,y1]=portPos(s,connectSrcPort);const p=cvPos(t.clientX,t.clientY);drawTempLine(x1,y1,connectSrcPort,p.x,p.y);}
  }
},{passive:true});

function cvPos(cx,cy){
  const r=cw.getBoundingClientRect();
  return{x:cx-r.left+cw.scrollLeft,y:cy-r.top+cw.scrollTop};
}

/* DRAG & DROP IMAGE */
function canvasDragOver(e){e.preventDefault();}
function canvasDrop(e){
  e.preventDefault();const f=e.dataTransfer?.files[0];
  if(!f||!f.type.startsWith('image/'))return;
  const r=new FileReader();r.onload=ev=>{
    const p=cvPos(e.clientX,e.clientY);
    const b={id:++blockIdCtr,type:'image',content:f.name,imgSrc:ev.target.result,x:p.x-100,y:p.y-60,w:200,order:pg().blocks.length+1};
    pg().blocks.push(b);selectedId=b.id;renderAll();showAbar();
  };r.readAsDataURL(f);
}

/* EDIT MODAL */
function openEditModal(id){
  editingId=id;const b=gb(id);if(!b)return;
  const ta=document.getElementById('edit-ta');ta.value=b.content;
  document.getElementById('modal-edit').style.display='flex';
  setTimeout(()=>{ta.focus();ta.setSelectionRange(ta.value.length,ta.value.length);},150);
}
function ctxEdit(){if(!selectedId)return;const b=gb(selectedId);if(b.type==='text')openEditModal(selectedId);else{pendingImgId=selectedId;document.getElementById('img-in').click();}}
function saveEdit(){
  const b=gb(editingId);if(b){const v=document.getElementById('edit-ta').value.trim();if(v)b.content=v;renderAll();toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß','‚úì');}
  closeModal('modal-edit');
}
function closeModal(id){document.getElementById(id).style.display='none';}

/* SEQUENCE */
function showSequence(){
  const p=pg();document.getElementById('seq-title').textContent=`‡∏•‡∏≥‡∏î‡∏±‡∏ö ‚Äî ${p.name}`;
  const body=document.getElementById('seq-body');
  const sorted=[...p.blocks].sort((a,b)=>a.order-b.order);
  let html='';
  if(!sorted.length){html='<p style="color:var(--muted);text-align:center;padding:24px 0;font-size:14px">‡πÑ‡∏°‡πà‡∏°‡∏µ Block</p>';}
  else sorted.forEach(b=>{
    const icon=b.type==='text'?'‚ú¶':'‚¨°';
    const col=b.type==='text'?'background:rgba(78,168,255,.15);color:var(--blue)':'background:rgba(62,207,142,.15);color:var(--green)';
    const prev=b.content.replace(/\n/g,' ').slice(0,46)+(b.content.length>46?'‚Ä¶':'');
    html+=`<div class="si"><div class="sn" style="${col}">${b.order}</div><span style="font-size:16px">${icon}</span><span class="sc">${esc(prev)}</span></div>`;
  });
  if(p.connections.length){
    const map=Object.fromEntries(p.blocks.map(b=>[b.id,b]));
    html+=`<div style="margin:18px 0 8px;font-size:10px;letter-spacing:1.4px;color:var(--muted)">CONNECTIONS</div>`;
    p.connections.forEach(c=>{const s=map[c.src],d=map[c.dst];if(s&&d)html+=`<div class="ci"><span style="color:var(--accent)">‚ü∂</span><span>#${s.order} ${esc(s.content.split('\n')[0].slice(0,16))}‚Ä¶</span><span style="color:var(--muted)">‚Üí</span><span>#${d.order} ${esc(d.content.split('\n')[0].slice(0,16))}‚Ä¶</span></div>`;});
  }
  body.innerHTML=html;document.getElementById('modal-seq').style.display='flex';
}

/* SAVE / LOAD */
function saveProject(){
  const d=JSON.stringify({version:'1.2',pages},null,2);
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([d],{type:'application/json'}));
  a.download=`block_note_${Date.now()}.blocknote`;a.click();toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß','üíæ');
}
function loadProject(){document.getElementById('load-in').click();}
function loadFile(e){
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();r.onload=ev=>{
    try{const d=JSON.parse(ev.target.result);pages=d.pages||[{id:1,name:'Page 1',blocks:[],connections:[]}];
      blockIdCtr=Math.max(0,...pages.flatMap(p=>p.blocks.map(b=>b.id)));pageIdCtr=Math.max(0,...pages.map(p=>p.id));
      curPage=0;selectedId=null;hideAbar();renderSidebar();renderAll();toast('‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','üìÇ');
    }catch(err){toast('‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+err.message,'‚ö†');}
  };r.readAsText(f);e.target.value='';
}

/* KEYBOARD */
document.addEventListener('keydown',e=>{
  if(e.ctrlKey&&e.key==='s'){e.preventDefault();saveProject();}
  if(e.key==='Escape'){cancelConnect();selectedId=null;hideAbar();updateClasses();}
  if((e.key==='Delete'||e.key==='Backspace')&&!['INPUT','TEXTAREA'].includes(document.activeElement.tagName))deleteSelected();
  if(e.ctrlKey&&e.key==='Enter'&&document.getElementById('modal-edit').style.display==='flex')saveEdit();
});

/* UTILS */
function esc(s=''){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
let toastT;
function toast(msg,icon='‚úì'){
  const el=document.getElementById('toast');el.innerHTML=`<span>${icon}</span><span>${msg}</span>`;
  el.classList.add('show');clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('show'),2200);
}
function vibrate(ms){navigator.vibrate?.(ms);}

/* INIT */
renderSidebar();renderAll();
setTimeout(()=>{
  if(pg().blocks.length===0){
    const b1={id:++blockIdCtr,type:'text',content:'‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ‚ú¶\n‡πÅ‡∏ï‡∏∞‡∏™‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç\n‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å',x:24,y:50,w:200,order:1};
    const b2={id:++blockIdCtr,type:'text',content:'‡∏Å‡∏î ‚ü∂ ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ï‡∏∞‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏°‡∏∏‡∏° Block ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏™‡∏≤‡∏¢',x:260,y:50,w:200,order:2};
    const b3={id:++blockIdCtr,type:'text',content:'‡∏Å‡∏î Ôºã FAB ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° Block',x:140,y:240,w:200,order:3};
    pg().blocks.push(b1,b2,b3);
    pg().connections.push({src:b1.id,src_port:'e',dst:b2.id,dst_port:'w'});
    pg().connections.push({src:b2.id,src_port:'s',dst:b3.id,dst_port:'n'});
    renderAll();
  }
},0);
</script>
</body>
</html>
